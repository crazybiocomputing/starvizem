<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf8">
    <title>Test Class2D</title>
    <script src="../javascripts/d3.js"></script>
    <script src="../js/raster.js"></script>
    
    <script type="text/javascript">
      function loadFile() {
        var input, file, fr;

        if (typeof window.FileReader !== 'function') {
            appendImage("p", "The file API isn't supported on this browser yet.");
            return;
        }

        input = document.getElementById('fileinput');
        if (!input) {
            appendText("p", "Um, couldn't find the fileinput element.");
        }
        else if (!input.files) {
            appendText("p", "This browser doesn't seem to support the `files` property of file inputs.");
        }
        else if (!input.files[0]) {
            appendText("p", "Please select a file before clicking 'Load'");
        }
        else {
            file = input.files[0];
            fr = new FileReader();
            fr.readAsArrayBuffer(file);
            fr.onload = readImage;
        }
        
        /**
         * Display float32 image
         *
         * @param {TWindow} win - Window used to display the image in the HTML5 page
         * @param {TImage} uint8 - Image containing uint8 pixels data
         * @param {boolean} copy - Useless. Just here for compatibility with other process/render functions.
         *
         * @author Jean-Christophe Taveau
         */
        const renderFloat32 = (canvas) => (imgf32) => {
          // Tutorial: https://hacks.mozilla.org/2011/12/faster-canvas-pixel-manipulation-with-typed-arrays/
          let ctx = canvas.getContext('2d');
          let imgdata = ctx.createImageData(imgf32.width, imgf32.height);
          
          // New RGBA image buffer
          let buf = new ArrayBuffer(imgf32.width * imgf32.height * 4);
          let buf32 = new Uint32Array(buf);
          let buf8 = new Uint8Array(buf);
          // Fill with ABGR color values
          let delta = 255.0 / (imgf32.statistics.max - imgf32.statistics.min) ;
          buf32.forEach( (px,i,arr) => {
            let pix = Math.floor((imgf32.pixelData[i] - imgf32.statistics.min) * delta );
            arr[i] = 255 << 24| pix << 16 | pix<< 8 | pix;
          });

          imgdata.data.set(buf8);
          ctx.putImageData(imgdata, 0, 0);
          
          // Flip Y-axis
          ctx.scale(1,-1);
          ctx.drawImage(canvas,0,-imgf32.height);
        };
        
        function readImage() {
          let raster = readMRC(fr);
          let elm = document.querySelector('canvas') || document.createElement('canvas');
          elm.width = raster.width;
          elm.height = raster.height;
          renderFloat32(elm)(raster);
          document.body.appendChild(elm);
        }
      }
      
      function appendText(tagName, innerHTML) {
        var elm;
        elm = document.createElement(tagName);
        elm.innerHTML = innerHTML;
        document.body.appendChild(elm);
      }
    </script>
  </head>
  <body>
    <h1>Tests of StarVizEM - Load MRC Image</h1>

    <form action='#' onsubmit="return false;">
    <input type='file' id='fileinput' ><br/>
    <input type='button' id='btnLoad' value='Load' onclick='loadFile();'>
    </form>

      
      <content id="root"></content>
  </body>
</html>

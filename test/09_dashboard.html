<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">  
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="HandheldFriendly" content="true">
    <title>Test XY Plot</title>
    <script src="../javascripts/d3.js"></script>
    <script src="http://d3js.org/d3.v5.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css">
    <script defer src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script>
    <script src="../js/common.js"></script>
    <script src="../js/arcDiagram.js"></script>
    <script src="../js/barChart.js"></script>
    <script src="../js/stacked_barchart.js"></script>
    <script src="../js/donut.js"></script>
    <script src="../js/plot1D.js"></script>
    <script src="../js/plot2D.js"></script>
    <script src="../js/mrc.js"></script>
    <script src="../js/raster.js"></script>
    <script src="../js/events.js"></script>
  </head>
  <body onload="createForm()">
    <section id="head" class="hero  is-primary">
      <div class="hero-body">
        <div  id="box" class="container">
          <h1 id="txt" class="title">StarVizEM</h1>
          <p id="txt" class="subtitle">A collection of tests for exploring various <strong>STAR Files</strong> generated by Relion.</p>
        </div>
      </div>
    </section>
    <header>
    <section>
      <aside>
          <content id="arcDiag"></content>
      </aside>
    </section>  
    <h3 style="display: inline">Show Images</h3>
    <input type='file' id='fileinput' ><br/>
    <input style="display: inline" type='button' id='btnLoad' value='Load' onclick='loadFile();'>
    </form>
    <br />
    <section id ="graphsection">
        <div id="graph1"></div>
        <div id="graph2"></div>
        <div id="graph3"></div>
    </section>
    <h2>Table</h2>
    <form id="getPlot" action="" method="post">
    <select id="table" name="table" onchange="changeTableHandler(event)">
    <option>----</option>
    </select>
    <select id="colX" name="colX">
    <option>----</option>
    <option value="_svzRowNumber">_svzRowNumber</option>
    </select>
    <select id="colY" name="colY">
    <option>----</option>
    </select>
    <button type="submit">Draw Plot</button>
     <input onclick='window.location.reload(false)' type="reset" value="Reset"/>
    </form>
    <form id="keywords">
    </form>
    </header>
    <section id ="plotSection">
        <div id="plot1"></div>
        <div id="plot2"></div>
    </section>

  <div id="container" class="svg-container">     
  <script type="text/javascript">
  // Global variable
  let workflow;
  let starobj;

  let plotForm = document.getElementById("getPlot");
   plotForm.addEventListener("submit", (event) => {
    event.preventDefault();
    drawPlot();
  });
  
  // Onload get default_pipeline.star and create form items
  const createForm = () => {
    console.log('createForm');
    d3.json('/pipeline')
      .then( (graph) => {
        workflow = graph;
        createArcDiagrams('arcDiag',graph);
      });
  };
  // Onload get default_pipeline.star and create form items
  const createXYForm = (obj) => {
    console.log('createXYForm');
    
    let set = new Set();
    obj.tables.forEach( (table)=> {
      set.add(table.name);
    });
    console.log(set);
    let select = document.getElementById('table');
    for (p of set) {
      let opt = document.createElement('option');
      opt.value = p;
      opt.text = p;
      select.appendChild(opt);
    }
  };
  const drawPlot = () => {
    console.log('Draw Plot');
    let formData = new FormData(document.getElementById('getPlot'));
    let cols = [];
    let table;
    for (let pair of formData.entries()) {
      console.log(pair[0] + ', ' + pair[1]);
      if (pair[0] !== "table") {cols.push(pair[1]);}
      if (pair[0] == "table") {table = pair[1]};
    }
    let starclass = Star.create(starobj);
    let dataTable = starclass.getTable(table);
    let data = cols.map( (d,i) => {
      let v = {
        name : d,
        d : dataTable.getColumn(d)
      };
      return v;
    });
    let plot1 = document.getElementById('plot1');
    let plot2 = document.getElementById('plot2');
    console.log(plot1.firstChild);
    if(plot1.firstChild) {
          console.log("Change graphs");
          plot1.removeChild(plot1.firstChild);
          plot2.removeChild(plot2.firstChild);
        }
    createPlots('plot1','plot2', data);
  }
  
  
  // Events
  const changeTableHandler = (event) => {
    let table = starobj.tables.find( (table) => table.name === event.target.value);
    let selectX = document.getElementById('colX');
    for (head of table.headers) {
      let opt = document.createElement('option');
      opt.value = head;
      opt.text = head;
      selectX.appendChild(opt);
    }
    let selectY = document.getElementById('colY');
    for (head of table.headers) {
      let opt = document.createElement('option');
      opt.value = head;
      opt.text = head;
      selectY.appendChild(opt);
    }
  };
    
  const createGraph = (donutID,barchartID,job) => {
    console.log(job);
  // Get JSON data from web service
  d3.json(job).then(function(graph) {
                console.log(graph)
                let width = 600;
                let height = 400;
                let starobj = Star.create(graph);
                let tableStat = starobj.getTable('statistics');
                let tableHisto = starobj.getTable('histogram_resolution');
                let start = tableStat.getColumnIndex('_svzNumberPerClass001');
                let datas = tableHisto.data.map ( (d,i) => ({
                nb: tableStat.data[start + i],
                labels: tableStat.headers[start + i].slice(13)
                }));
                dataR = regroupLowData(datas);
                let donutplace= document.getElementById(donutID);
                donutplace.appendChild(createDonut(dataR, width, height));
            });
  d3.json(job).then(function(graph) {
                let width = 600;
                let height = 400;
                let barplace = document.getElementById(barchartID);
                barplace.appendChild(createStackedBarChart(graph, width, height));
  
            });
        
  }
  const createPlots = (plot1DID,plot2DID, datas) => {
  // Get JSON data from web service
    let width = 600;
    let height = 400;
    let data = [];
    let labels = { 
      xlabel : datas[0].name,
      ylabel : datas[1].name
    };
    for (let i = 0; i < datas[0].d.length; i++){
      let temp = {};
      temp["x"] = datas[0].d[i];
      temp["y"] = datas[1].d[i];
      console.log(temp);
      data.push(temp);
    }
    console.log(data);
    
    let plot1Dplace = document.getElementById(plot1DID);
    plot1Dplace.appendChild(createPlot(data, labels, width, height));
    let plot2Dplace = document.getElementById(plot2DID);
    plot2Dplace.appendChild(createCurvePlot(data, labels, width, height));
  };  


   const createArcDiagrams = (rootID,graph) => {
  // Get JSON data from web service
  d3.json('/pipeline').then(function(graph) {
    let width = 1200;
    let height = 250;
    let data_nodes = [];
    let data_links = [];
    graph.jobs.forEach((d) => {
        data_nodes.push({
        id: d.jobID,
        process: d.process,
        value: d.targets.length,
        name: d.name,
        alias: d.alias,
        //Get the first output file by default
        mainOutput: d.outputs[0].file
        });
       if (d.targets.length !== 0) {
            d.targets.forEach((t) => {
            data_links.push({
            source: d.jobID,
            value: d.targets.length,
            target: t
            });
            });
            }
      });

      console.log(graph);
      let arcDiagramPlace=document.getElementById(rootID);
      arcDiagramPlace.appendChild(createArcDiagram({nodes: data_nodes,links: data_links}, width, height));
    });
    };
  
  function regroupLowData(data){
        let values = [];
        let deletevalues = [];
        data.forEach(function(e){ return values.push(e.nb); });
        let totalvalues = values.reduce((a, b) => a + b, 0);
        values.sort(function(a,b){ return a-b;});
        let threshval = 5*totalvalues/100;
        let somme = 0;
        let bool = false;
        
        for (let i = 0; i < values.length; i++){
            somme = somme + values[i];
            if (somme >= threshval){
                let index = i-1;
                somme = somme - values[i];
                for(let j = 0; j < index; j++){
                    deletevalues.push(values.shift());
                    bool = true;
                }
                if (bool == true){
                    values.push(somme);
                }
            break;
            }
        }
        for (let i = 0; i < data.length; i++){
            for (let j = 0; j < deletevalues.length; j++){
                if (deletevalues[j]){
                    data = data.filter(function (item){
                        return item.nb !== deletevalues[j]
                    });
                }
            }
        }
        if (deletevalues.length != 0){
            data.push({labels: "Other", nb: somme });
        }
        return data;
    }
    
    function loadFile() {
        var input, file, fr;
        if (typeof window.FileReader !== 'function') {
            appendImage("p", "The file API isn't supported on this browser yet.");
            return;
        }
        input = document.getElementById('fileinput');
        if (!input) {
            appendText("p", "Um, couldn't find the fileinput element.");
        }
        else if (!input.files) {
            appendText("p", "This browser doesn't seem to support the `files` property of file inputs.");
        }
        else if (!input.files[0]) {
            appendText("p", "Please select a file before clicking 'Load'");
        }
        else {
            file = input.files[0];
            fr = new FileReader();
            fr.readAsArrayBuffer(file);
            fr.onload = readStack;
        }
        function readStack() {
          /*if ( (childnode = document.querySelector('section')) !== null) {
            childnode.remove();
          }*/
          let raster = Raster.create(readMRC(fr));
          let montage = raster.montage();
          montage.style = "width: 600px; height: 400px; border: 2px solid rgba(2, 0, 34, 0.897);float:left; overflow-y: scroll ";
          montage.setAttribute("preserveAspectRatio", "xMinYMin meet");
          montage.setAttribute("viewBox", "0 0 600 400");
          montage.setAttribute("svg-content", true);
          document.getElementById("graph3").appendChild(montage);
        }
      }
      
    function appendText(tagName, innerHTML) {
      var elm;
      elm = document.createElement(tagName);
      elm.innerHTML = innerHTML;
      document.getElementById("graphs").appendChild(elm);
    }
    </script>
    </div>
      
    <style>
    @media screen and (max-width: 3000px) {     
      
    html { 
      font-size:100%; 
      }

    #plotSection {
        display:grid;
        grid-template-columns: 1fr 1fr;
      }

    #plot1 {
        grid-column: 1;
    }

    #plot2 {
        grid-column: 2;
    }


    #graphsection {
        display:grid;
        grid-template-columns: 33% 33% 33%;
        padding: 2%;
    }

    #graph1 {
        grid-column: 1;
    }

    #graph2 {
        grid-column: 2;
    }

    #graph3 {
        grid-column: 3;
    }

    .montage {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      max-width: 100%;
    }
      
    .zoom {
      padding: 1%;
      transition: transform .2s; /* Animation */
      margin: 0.5%;
      width: 30%;
      height: 30%;
    }
      
    .zoom:hover {
      transform: scale(1.5); /* (150% zoom - Note: if the zoom is too large, it will go outside of the viewport) */
    }
    
    figure canvas {
      border: 1px solid black;
      width: 65%;
      height: 65%;
    }

    #head{
        width: auto;
        height: 100px;
        text-align: left;
    }

    #txt{
        display: inline;
        margin: auto;
        font-size:1rem;
    }

    #box{
        margin:auto;
    }

    #bas{
        width: auto;
        height: 30%;
        text-align: center;
    }
      
    .labelValue{
        font-size: 60%;
        opacity: .5;
    }

    div.tooltip {
        position: absolute;
        width: auto;
        height: auto;
        padding: 5px;
        font-size:0.8rem;
        background: lightsteelblue;
        border: 0px;
        border-radius: 8px;
      }

    .toolTip {
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        position: absolute;
        display: none;
        width: auto;
        height: auto;
        background: none repeat scroll 0 0 white;
        border: 0 none;
        border-radius: 8px 8px 8px 8px;
        box-shadow: -3px 3px 15px #888888;
        color: black;
        font-size:0.8rem;
        padding: 5px;
        text-align: center;
    
    }
  }
    </style>
  </script>
 <section >
    <footer id="bas" class="footer">
     <div id="box" class="container">
       <div class="content has-text-centered">
         <p id="txt">
           <strong>StarVizEM</strong> by Jean-Christophe Taveau.</p> </br></br> <p>The source code is licensed GPLv3.0. The website content
           is licensed <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY NC SA 4.0</a>.</p>
         </p>
         <p id="txt"><strong>Contributors</strong>: Pauline Bock, Cyril Dourthe, Marie Econimides, Guillaume Sotton.</p>
        </br></br>
         <p id="txt">
           <span class="tag is-dark">STAR Files</span>
           <span class="tag is-dark">cryoEM</span>
           <span class="tag is-dark">RELION</span>
           <span class="tag is-dark">ES2015+</span>
           <span class="tag is-dark">Node.js</span>
           <span class="tag is-dark">HTML5</span>
           <span class="tag is-dark">CSS3</span>
           <span class="tag is-dark">D3.js</span>
         </p>
       </div>
     </div>
   </footer>
 </section>
  </body>
</html>

<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">  
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="HandheldFriendly" content="true">
    <title>Test XY Plot</title>
    <script src="../javascripts/d3.js"></script>
    <script src="http://d3js.org/d3.v5.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css">
    <script defer src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script>
    <script src="../js/common.js"></script>
    <script src="../js/arcDiagram.js"></script>
    <script src="../js/barChart.js"></script>
    <script src="../js/stacked_barchart.js"></script>
    <script src="../js/donut.js"></script>
    <script src="../js/plot1D.js"></script>
    <script src="../js/plot2D.js"></script>
    <script src="../js/mrc.js"></script>
    <script src="../js/raster.js"></script>
  </head>
  <body onload="createForm()">
    <section id="head" class="hero  is-primary">
      <div class="hero-body">
        <div  id="box" class="container">
          <h1 id="txt" class="title">StarVizEM</h1>
          <p id="txt" class="subtitle">A collection of tests for exploring various <strong>STAR Files</strong> generated by Relion.</p>
        </div>
      </div>
    </section>
    <header>
    <h2>STAR File</h2>
    <form id="getstar" action="/star" method="post">
    <select id="process" name="process" onchange="changeProcessHandler(event)">
    <option>----</option>
    </select>
    <select id="job" name="job" onchange="changeJobHandler(event)">
    <option>----</option>
    </select>
    <select id="starfile" name="starfile">
    <option>----</option>
    </select>
    <button type="submit">Get STAR</button>
    <h3 style="display: inline">Show Images</h3>
    <input type='file' id='fileinput' ><br/>
    <input style="display: inline" type='button' id='btnLoad' value='Load' onclick='loadFile();'>
    </form>
    <br />
    <section>
      <aside>
        <content id="graphs"></content>
      </aside>
    </section>
    <h2>Table</h2>
    <form id="getPlot" action="" method="post">
    <select id="table" name="table" onchange="changeTableHandler(event)">
    <option>----</option>
    </select>
    <select id="colX" name="colX">
    <option>----</option>
    <option value="_svzRowNumber">_svzRowNumber</option>
    </select>
    <select id="colY" name="colY">
    <option>----</option>
    </select>
    <button type="submit">Draw Plot</button>
     <input onclick='window.location.reload(false)' type="reset" value="Reset"/>
    </form>
    <form id="keywords">
    </form>
    </header>
    <content id="d3"></content>


    <section id="fig"> 
    <svg id="chart">
    </svg>
  <script type="text/javascript">
  // Global variable
  let workflow;
  let starobj;
  let mainForm = document.getElementById("getstar");
   mainForm.addEventListener("submit", function(event) {
    event.preventDefault();
    getSTARFile();
  });
  let plotForm = document.getElementById("getPlot");
   plotForm.addEventListener("submit", (event) => {
    event.preventDefault();
    drawPlot();
  });
  
  // Onload get default_pipeline.star and create form items
  const createForm = () => {
    console.log('createForm');
    d3.json('/pipeline')
      .then( (graph) => {
        workflow = graph;
        
        let set = new Set();
        graph.jobs.forEach( (job)=> {
          set.add(job.process);
        });
        console.log(set);
        let select = document.getElementById('process');
        for (p of set) {
          let opt = document.createElement('option');
          opt.value = p;
          opt.text = getProcessName(p);
          select.appendChild(opt);
        }
      });
  };
  // Onload get default_pipeline.star and create form items
  const createXYForm = (obj) => {
    console.log('createXYForm');
    
    let set = new Set();
    obj.tables.forEach( (table)=> {
      set.add(table.name);
    });
    console.log(set);
    let select = document.getElementById('table');
    for (p of set) {
      let opt = document.createElement('option');
      opt.value = p;
      opt.text = p;
      select.appendChild(opt);
    }
  };
  const drawPlot = () => {
    console.log('Draw Plot');
    let formData = new FormData(document.getElementById('getPlot'));
    let cols = [];
    let table;
    for (let pair of formData.entries()) {
      console.log(pair[0] + ', ' + pair[1]);
      if (pair[0] !== "table") {cols.push(pair[1]);}
      if (pair[0] == "table") {table = pair[1]};
    }
    let starclass = Star.create(starobj);
    let dataTable = starclass.getTable(table);
    let data = cols.map( (d,i) => {
      let v = {
        d : dataTable.getColumn(d)
      };
      return v;
    });
    console.log(data);
    createPlots('d3', data);
  }
  
  
  // Events
  const changeProcessHandler = (event) => {
    let selectedJobs = workflow.jobs.filter( (job) => job.process === parseInt(event.target.value));
    let select = document.getElementById('job');
    for (j of selectedJobs) {
      let opt = document.createElement('option');
      opt.value = j.jobID;
      opt.text = j.name.split('/')[1];
      select.appendChild(opt);
    }
  };
  const changeJobHandler = (event) => {
    let job = workflow.jobs.find( (j) => j.jobID === parseInt(event.target.value));
    let select = document.getElementById('starfile');
    for (k in job.outputs) {
      let filename = job.outputs[k].file.split('/')[2];
      let opt = document.createElement('option');
      opt.value = filename;
      opt.text = filename;
      select.appendChild(opt);
    }
  };
  const changeTableHandler = (event) => {
    let table = starobj.tables.find( (table) => table.name === event.target.value);
    let selectX = document.getElementById('colX');
    for (head of table.headers) {
      let opt = document.createElement('option');
      opt.value = head;
      opt.text = head;
      selectX.appendChild(opt);
    }
    let selectY = document.getElementById('colY');
    for (head of table.headers) {
      let opt = document.createElement('option');
      opt.value = head;
      opt.text = head;
      selectY.appendChild(opt);
    }
  };
  // Get the STAR File
  const getSTARFile = (rootID,datas) => {
    console.log('getSTARFile');
    // Get JSON data
    let formData = new FormData(document.getElementById('getstar'));
    let jsonFormData = {};
    for (let pair of formData.entries()) {
      jsonFormData[pair[0]] = pair[1];
    }
    let processName = getProcessName(jsonFormData.process).replace(/\s/g,"");
    let jobnb = "job"+jsonFormData.job.toString().padStart(3,'0');
    let path = "/"+processName+"/"+jobnb+"/";
    fetch('/star',{
      headers: new Headers({'Content-Type': 'application/json'}),
      method: "POST",
      mode: 'cors',
      body: JSON.stringify(jsonFormData) // formData
    })
      .then ( (response) => response.json() )
      .then ( (data) => {
        console.log(data);
        starobj = data;
        createXYForm(data);
        createGraph("graphs",path);
        //loadFile(path);
    });
  };
    
  const createGraph = (rootID,job) => {
    console.log(job);
  // Get JSON data from web service
  d3.json(job).then(function(graph) {
                console.log(graph)
                let width = 400;
                let height = 400;
                let starobj = Star.create(graph);
                let tableStat = starobj.getTable('statistics');
                let tableHisto = starobj.getTable('histogram_resolution');
                let start = tableStat.getColumnIndex('_svzNumberPerClass001');
                let datas = tableHisto.data.map ( (d,i) => ({
                nb: tableStat.data[start + i],
                labels: tableStat.headers[start + i].slice(13)
                }));
                dataR = regroupLowData(datas);
                let donutplace= document.getElementById(rootID);
                donutplace.appendChild(createDonut(dataR, width, height));
            });
  d3.json(job).then(function(graph) {
                let width = 400;
                let height = 400;
                let barplace = document.getElementById(rootID);
                barplace.appendChild(createStackedBarChart(graph, width, height));
  
            });
        
  }
  const createPlots = (rootID, datas) => {
  // Get JSON data from web service
    let width = 400;
    let height = 400;
    let data = [];
    for (let i = 0; i < datas[0].d.length; i++){
      let temp = {};
      temp["x"] = datas[0].d[i];
      temp["y"] = datas[1].d[i];
      console.log(temp);
      data.push(temp);
    }
    console.log(data);
    
    let plotplace = document.getElementById(rootID);
    plotplace.appendChild(createPlot(data, width, height));
    plotplace.appendChild(createCurvePlot(data, width, height));
  };  
  
  function regroupLowData(data){
        let values = [];
        let deletevalues = [];
        data.forEach(function(e){ return values.push(e.nb); });
        let totalvalues = values.reduce((a, b) => a + b, 0);
        values.sort(function(a,b){ return a-b;});
        let threshval = 5*totalvalues/100;
        let somme = 0;
        let bool = false;
        
        for (let i = 0; i < values.length; i++){
            somme = somme + values[i];
            if (somme >= threshval){
                let index = i-1;
                somme = somme - values[i];
                for(let j = 0; j < index; j++){
                    deletevalues.push(values.shift());
                    bool = true;
                }
                if (bool == true){
                    values.push(somme);
                }
            break;
            }
        }
        for (let i = 0; i < data.length; i++){
            for (let j = 0; j < deletevalues.length; j++){
                if (deletevalues[j]){
                    data = data.filter(function (item){
                        return item.nb !== deletevalues[j]
                    });
                }
            }
        }
        if (deletevalues.length != 0){
            data.push({labels: "Other", nb: somme });
        }
        return data;
    }
    
    function loadFile() {
        var input, file, fr;
        if (typeof window.FileReader !== 'function') {
            appendImage("p", "The file API isn't supported on this browser yet.");
            return;
        }
        input = document.getElementById('fileinput');
        if (!input) {
            appendText("p", "Um, couldn't find the fileinput element.");
        }
        else if (!input.files) {
            appendText("p", "This browser doesn't seem to support the `files` property of file inputs.");
        }
        else if (!input.files[0]) {
            appendText("p", "Please select a file before clicking 'Load'");
        }
        else {
            file = input.files[0];
            fr = new FileReader();
            fr.readAsArrayBuffer(file);
            fr.onload = readStack;
        }
        function readStack() {
          /*if ( (childnode = document.querySelector('section')) !== null) {
            childnode.remove();
          }*/
          let raster = Raster.create(readMRC(fr));
          let montage = raster.montage();
          montage.style = "width: 400px; height: 400px; border: 2px solid rgba(2, 0, 34, 0.897);float:left; overflow-y: scroll;";
          document.getElementById("graphs").appendChild(montage);
        }
      }
      
    function appendText(tagName, innerHTML) {
      var elm;
      elm = document.createElement(tagName);
      elm.innerHTML = innerHTML;
      document.getElementById("graphs").appendChild(elm);
    }
    </script>
    </section>
    
    <style>
    @media screen and (max-width: 1060px) {     
      
    html { 
      font-size:100%; 
      }  


    .svg-container {
    display: inline-block;
    position: relative;
    width: 100%;
    padding-bottom: 100%; /* aspect ratio */
    vertical-align: top;
    overflow: hidden;
}
.svg-content-responsive {
    display: inline-block;
    position: absolute;
    top: 10px;
    left: 0;
}

    .montage {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      max-width: 100%;
    }
    .zoom {
      padding: 1px;
      transition: transform .2s; /* Animation */
      margin: 1px;
    }
    .zoom:hover {
      transform: scale(1.5); /* (150% zoom - Note: if the zoom is too large, it will go outside of the viewport) */
    }
    
    figure canvas {
      border: 1px solid black;
    }

     #head{
        width: auto;
        height: 100px;
        text-align: left;
    }

    #txt{
        display: inline;
        margin: auto;
        font-size:1rem;
    }

    #box{
        margin:auto;
    }

    #bas{
        width: auto;
        height: 10%;
        font-size:1rem;
        position: absolute;
        bottom: 0;
    }

    #fig{
        max-width: 100%;
        height:200px;
        padding: 5px;

    }

    .labelValue{
        font-size: 60%;
        opacity: .5;
    }

    div.tooltip {
        position: absolute;
        width: auto;
        height: auto;
        padding: 5px;
        font-size:1rem;
        background: lightsteelblue;
        border: 0px;
        border-radius: 8px;
      }

    .toolTip {
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        position: absolute;
        display: none;
        width: auto;
        height: auto;
        background: none repeat scroll 0 0 white;
        border: 0 none;
        border-radius: 8px 8px 8px 8px;
        box-shadow: -3px 3px 15px #888888;
        color: black;
        font-size:1rem;
        padding: 5px;
        text-align: center;
    
    }

    .footer {
      width: 100%;
      height: 1%;
      position: absolute; 
      bottom: auto; 
    }

  }
    </style>
  </script>
  </body>
</html>
